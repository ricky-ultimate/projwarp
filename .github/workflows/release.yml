name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $NAME = "projwarp-${{ github.ref_name }}-${{ matrix.target }}"
          New-Item -ItemType Directory -Path $NAME -Force | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/projwarp.exe" -Destination "$NAME/"
          Copy-Item "README.md" -Destination "$NAME/"
          Copy-Item "LICENSE" -Destination "$NAME/"
          Copy-Item "install.ps1" -Destination "$NAME/"
          Compress-Archive -Path $NAME -DestinationPath "$NAME.zip"
          echo "ASSET=$NAME.zip" >> $env:GITHUB_ENV

          # Calculate SHA256
          $hash = (Get-FileHash -Path "$NAME.zip" -Algorithm SHA256).Hash
          echo "SHA256=$hash" >> $env:GITHUB_ENV
          echo "Windows SHA256: $hash"

      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          NAME="projwarp-${{ github.ref_name }}-${{ matrix.target }}"
          mkdir $NAME
          cp "target/${{ matrix.target }}/release/projwarp" "$NAME/"
          cp README.md LICENSE "$NAME/"
          tar -czf "$NAME.tar.gz" "$NAME"
          echo "ASSET=$NAME.tar.gz" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ${{ env.ASSET }}

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip-crates]')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_TOKEN }}
        continue-on-error: true

  publish-chocolatey:
    name: Publish to Chocolatey
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip-choco]')
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: x86_64-pc-windows-msvc
          path: ./artifacts

      - name: Get release info
        id: release_info
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_ENV

          $zipFile = Get-ChildItem -Path ./artifacts -Filter "*.zip" | Select-Object -First 1
          $hash = (Get-FileHash -Path $zipFile.FullName -Algorithm SHA256).Hash
          echo "SHA256=$hash" >> $env:GITHUB_ENV
          echo "Chocolatey SHA256: $hash"

      - name: Update nuspec
        run: |
          $nuspec = Get-Content "choco/projwarp.nuspec" -Raw
          $nuspec = $nuspec -replace '<version>.*?</version>', "<version>${{ env.VERSION }}</version>"
          Set-Content "choco/projwarp.nuspec" $nuspec

      - name: Update chocolateyinstall.ps1
        run: |
          $install = Get-Content "choco/tools/chocolateyinstall.ps1" -Raw
          $install = $install -replace "v\d+\.\d+\.\d+", "${{ github.ref_name }}"
          $install = $install -replace "checksum64\s*=\s*'[^']*'", "checksum64    = '${{ env.SHA256 }}'"
          Set-Content "choco/tools/chocolateyinstall.ps1" $install

      - name: Pack Chocolatey package
        run: |
          cd choco
          choco pack

      - name: Push to Chocolatey
        run: |
          cd choco
          choco apikey --key ${{ secrets.CHOCOLATEY_API_KEY }} --source https://push.chocolatey.org/
          choco push projwarp.${{ env.VERSION }}.nupkg --source https://push.chocolatey.org/
        continue-on-error: true
